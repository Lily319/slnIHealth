@model IEnumerable<prjIHealth.ViewModels.CCoachViewModel>
@{
    IHealthContext db = new IHealthContext();
}
@section Styles{
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /*多重篩選*/
        .divSelCity {
            padding-left: 10px;
            text-align: right;
        }

            .divSelCity > div {
                width: 180px;
            }

        #selCity {
            display: inline !important;
        }

        .nice-select {
            display: none;
        }

        .filter {
            margin: 30px 0px;
        }

        .divFilter {
            padding-right: 40px;
        }

        .divfilterTopic {
            margin-bottom: 15px;
        }

            .divfilterTopic b {
                color: #7fad39;
            }

        .keyTopic {
            margin-bottom: 10px;
            padding: 10px 0px;
            border-bottom: 1px solid lightgray;
        }

        .filterCard {
            margin-bottom: 25px;
        }

        #btnSubmit {
            display: block;
            width: 100%;
            border-color: #7fad39;
        }

        .skillCount {
            font-weight: 600;
            color: gray;
        }

        /*關鍵字*/
        .divSearch {
            display: flex;
            align-items:center;
        }

        .divKeyword {
            display: flex;
        }

        .divSubmit {
            height: 38px;
            padding: 0px;
            margin: 0px;
            text-align: center;
        }

        .hero__search__form, .divCoachList {
            width: 100%;
        }

        .inKeyword {
            border-bottom-right-radius: 0px;
            border-top-right-radius: 0px;
        }

        .btnSearch {
            height: 38px;
            border-bottom-left-radius: 0px;
            border-top-left-radius: 0px;
        }
        .divLink {
            display: flex;
            justify-content:right;
            height: 70px;
        }

        .divOther {
            padding: 0px;
        }

            .divOther span {
                color: #5F822B;
                line-height: 70px;
            }

            .divOther i {
                color: #5F822B;
            }

        .divUrl {
            margin-left: 10px;
            padding: 10px;
            line-height: 48px;
            border: 1px solid #BFD69C;
            border-radius: 20px;
        }

            .divUrl i {
                color: #DFEACE;
            }

            .divUrl a {
                color: #7FAD39;
                text-decoration: none;
                transition: .3s;
            }

                .divUrl a:hover {
                    color: #5F822B;
                }

        /*列表*/
        .divRight {
            padding: 0px 20px;
        }

        .divCoachCount {
            text-align: right;
        }

        .divCoachCard {
            display: flex;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid whitesmoke;
            box-shadow: 2px 2px 5px lightgray;
        }

        .divImg {
            text-align: right;
            display: flex;
            align-items: center;
        }

        .imgCoach {
            border-radius: 50%;
            width: 150px;
            height: 150px;
            margin: auto;
        }

        .divCoachInfo {
            padding: 20px;
        }

        .imgIcon {
            height: 20px;
        }

        .li {
            margin: 5px 0px;
        }

        .liCoachName {
            margin-bottom: 10px;
            display:flex;
        }

        .liSlogan {
            margin-top: 18px;
        }

            .liSlogan span {
                line-height: 30px;
            }

        .divPage {
            text-align: right;
        }

        .btn-success {
            background-color: #7fad39;
            border: none;
        }

        .btn-light {
            background-color: #4F6C24;
            color: white;
        }

            .btn-light:hover {
                background-color: #304115;
                color: white;
            }

        .star {
            height: 18px;
        }

        .starOrig {
            filter: grayscale(1);
        }

        .liAvgRate {
            margin-bottom: 20px !important;
            display: flex;
        }
        .divBtnDetail {
            text-align: center;
            padding: 8px;
            border: 2px solid #7fad39;
            border-radius:5px;
            transition:.3s;
        }
            .divBtnDetail a {
                display:block;
                width:100%;
                height:100%;
                color: #7fad39;
                font-weight: 600;
            }
            .divBtnDetail:hover {
                border: 2px solid #5F822B;
            }
            .divBtnDetail a:hover {
                color: #5F822B;
            }
    </style>
}

@*banner大圖*@
<section class="breadcrumb-section set-bg" data-setbg="/img/Coach/Banner.jpg">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="breadcrumb__text">
                    @*h2內容請自行更換*@
                    <h2>私人教練專區</h2>
                    <div class="breadcrumb__option">
                        <a href="~/Student/CoachMainPage">Home</a>
                        <span>Training</span>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<section class="product spad">
    <div class="container">
        <div class="row">
            @*※※※非會員專區的View的內容請從此處開始※※※*@
            <div class="col-lg-3">
                <div class="reveal_l1">
                    <form method="post" name="frmFilter">
                        <div class="divFilter">
                            <div class="divfilterTopic">
                                <h5><b>篩選條件</b></h5>
                            </div>
                            <div class="filterCard">
                                <div class="keyTopic">
                                    <h6><b>地區</b></h6>
                                </div>
                                <div>
                                    <select class="custom-select" id="selCity" name="FCityId">
                                        <option selected disabled>請選擇地區</option>
                                        @{
                                            foreach (var c in db.TCities.Where(c=>c.TCoaches.Any()).ToList())
                                            {
                                                <option value="@c.FCityId" id="@c.FCityId">@c.FCityName</option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="filterCard">
                                <div class="keyTopic">
                                    <h6><b>教練性別</b></h6>
                                </div>
                                <div>
                                    <input type="checkbox" value="True" name="fGender[]" /><label>&nbsp;男性</label><br />
                                    <input type="checkbox" value="False" name="fGender[]" /><label>&nbsp;女性</label><br />
                                </div>
                            </div>
                            <div class="filterCard">
                                <div class="keyTopic">
                                    <h6><b>專長項目</b></h6>
                                </div>
                                <div>
                                    @{
                                        foreach (var s in db.TSkills.ToList())
                                        {
                                            <input type="checkbox" value="@s.FSkillId" name="fCoachSkill[]" />
                                            <label>
                                                &nbsp;@s.FSkillName
                                                <span class="skillCount">(@db.TCoachSkills.Where(cs => cs.FSkillId == s.FSkillId).Count())</span>
                                            </label><br />
                                        }
                                    }
                                </div>
                            </div>
                            <div class="filterCard">
                                <div class="keyTopic">
                                    <h6><b>可上課時段</b></h6>
                                </div>
                                <div>
                                    @{
                                        foreach (var t in db.TAvailableTimes.Where(at=>at.FAvailableTimeId<=6).ToList())
                                        {
                                            <input type="checkbox" value="@t.FAvailableTimeId" name="fCoachTime[]" /><label>&nbsp;@t.FAvailableTime</label><br />
                                        }
                                    }
                                </div>
                            </div>
                            <div class="form-group filterSubmit">
                                <input type="submit" value="篩選" id="btnSubmit" class="btn btn-success" />
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="col-lg-9 divRight">
                <div class="divSearch row">
                    <form class="col-lg-7">
                        <div class="divKeyword reveal_t1">
                            <input type="text" name="txtKeyword" id="ipKeyword" class="form-control inKeyword" placeholder="請輸入關鍵字">
                            <div class="divSubmit">
                                <button type="submit" class="btn btn-success btnSearch" id="btnSearch"><i class="fa-solid fa-magnifying-glass"></i></button>
                            </div>
                        </div>
                    </form>
                    <div class="divLink col-lg-5">
                        <div class="divOther reveal_t1"><i class="fa-solid fa-user-plus"></i><span><b>&nbsp;&nbsp;想找學生？</b></span></div>
                        <div class="divUrl reveal_r1"><i class="fa-solid fa-arrow-right-long"></i><a href="~/Coach/CreateResume">&nbsp;&nbsp;前往<b>刊登履歷</b></a></div>
                    </div>                    
                </div>
                <div class="row filter">
                    <div class="col-lg-4 col-md-5">
                        <div class="filter__sort">
                            <span>排序依據</span>
                            <select>
                                <option value="1">預設</option>
                                <option value="2">加入日期新至舊</option>
                                <option value="3">加入日期舊至新</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-4">
                        <div class="filter__found divCoachCount">
                            <h6>共  <span>@Model.ToArray().Length</span> 位私人教練</h6>
                        </div>
                    </div>
                </div>
                <div class="divCoachList">
                    @{
                        foreach (var coach in Model)
                        {
                            <div class="divCoachCard row reveal_b1">
                                <label hidden>@coach.FCoachId</label>
                                <label hidden>@coach.Gender</label>
                                <div class="col-3 divImg">
                                    <img src="/img/coach/coachImage/@coach.FCoachImage" class="imgCoach">
                                </div>
                                <div class="col-9 divCoachInfo">
                                    <ul>                                        
                                        <li style="list-style:none" class="liCoachName row">
                                            <h3 class="col-8"><b>@coach.FCoachName</b></h3>
                                            <div class="col-3 divBtnDetail"><a href="/Student/ViewCoachDetails/@coach.FCoachId">教練檔案</a></div>                                        
                                        </li>
                                        <li style="list-style:none" class="li liAvgRate">
                                            <span id="avg_@coach.FCoachId"></span>&nbsp;&nbsp;&nbsp;
                                            <img class="star starOrig" src="~/img/coach/icon/star.png" id="star1_@coach.FCoachId" />
                                            <img class="star starOrig" src="~/img/coach/icon/star.png" id="star2_@coach.FCoachId" />
                                            <img class="star starOrig" src="~/img/coach/icon/star.png" id="star3_@coach.FCoachId" />
                                            <img class="star starOrig" src="~/img/coach/icon/star.png" id="star4_@coach.FCoachId" />
                                            <img class="star starOrig" src="~/img/coach/icon/star.png" id="star5_@coach.FCoachId" />&nbsp;&nbsp;&nbsp;
                                            <span id="rateCount">(@coach.RateCount)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            <span id="courseCount">@coach.FCourseCount 次成交&nbsp;<i class="fa-regular fa-circle-check"></i></span>
                                        </li>
                                        <li style="list-style:none" class="li">
                                            <img src="~/img/Coach/icon/location.png" class="imgIcon" /><b>&nbsp;&nbsp;&nbsp;授課地區： </b>
                                            <span>@coach.CityName</span>
                                        </li>
                                        <li style="list-style:none" class="li">
                                            <img src="~/img/Coach/icon/skill.png" class="imgIcon" />
                                            <b>&nbsp;&nbsp;&nbsp;專長： </b>
                                            @{
                                                string s = "";
                                                foreach (var c in coach.Coach.TCoachSkills)
                                                {
                                                    string skillName = c.FSkill.FSkillName;
                                                    s += skillName;
                                                    s += "、";
                                                }
                                                if (s.Length != 0)
                                                {
                                                    s = s.Substring(0, s.Length - 1);
                                                }
                                                <span class="spSkill">@s</span>
                                            }
                                        </li>
                                        <li style="list-style:none" class="liSlogan"><span>@coach.FSlogan</span></li>
                                    </ul>
                                </div>
                            </div>
                        }
                    }
                </div>
                <div class="product__pagination divPage">
                    <a href="#">1</a>
                    <a href="#">2</a>
                    <a href="#">3</a>
                    <a href="#"><i class="fa fa-long-arrow-right"></i></a>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts{
    @{
        //每位教練平均評價
        foreach (var coach in Model)
        {
            decimal avgRate;
            if (coach.RateCount != 0)
            {
                avgRate = ((int)db.TCoachRates.Where(r => r.FCoachId == coach.FCoachId).Select(r => r.FRateStar).Sum()) / coach.RateCount;
            }
            else
            {
                avgRate = 0;
            }
            string avg = avgRate.ToString("0.0");
            <script>
                $(`#avg_@coach.FCoachId`).text("@avg");
                for (let i = 1; i <=@avgRate; i++) {
                    $(`#star${i}_@coach.FCoachId`).removeClass("starOrig");
                    }
            </script>
        }

    }
    <script>

        const formData = new FormData(document.frmFilter);
        $("#selCity").change(() => {
            //if ($(this).find("input[type=checkbox]:checked").val() != undefined) {
            //    //let result = $(this).find("input[type=checkbox]:checked").val();
                $.post({
                    url: 'Student/MultiFilter',
                    type: 'POST',
                    data: formData,
                    //dataType: Text,
                    contentType: false,
                    cache: false,
                    processData: false
                }).done((data) => {
                    console.log(data);
                })
        })

        //TODO 畫面上保留搜尋條件
        //let city;
        //let keyword;
        //$("#selCity").text(city);
        //$("#ipKeyword").text(keyword);
        //$("#selCity").change(() => {
        //    city = $("#selCity").text();
        //    console.log(city);
        //})
        //$("#ipKeyword").blur(() => {
        //    keyword = $("#ipKeyword").text();
        //    console.log(keyword);
        //})

        @*$.get("@Url.Content("~/Student/GetCurrentCategory")", function (data) {
            console.log(data);
            $(`#Category${data}`).addClass("current").siblings().addClass("orig");
        })*@

        @*$(".ulCategory li a").click(() => {
            $.get("@Url.Content("~/Student/GetCurrentCategory")", function (data) {
            console.log(data);
            $(`#Skill${data}`).addClass("current").siblings().addClass("orig");
        })
        })*@
    </script>
}